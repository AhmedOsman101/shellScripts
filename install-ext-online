#!/usr/bin/env bash

origin="$1"

file=$(mktemp -t "XXXXXX.json")
trap 'rm -f $file' EXIT

get-ext "${file}" -o &>/dev/null

if [[ ! -s "${origin}" ]]; then
  origin="[]"
  log-error "No entries found in ${origin}"
  exit 0
fi

if [[ -s "${file}" ]]; then
  # Combine JSON files with only unique enteries as an array
  extensions="$(jq -s 'flatten' "${origin}" "${file}" | getUnique | sed 's/, *]/]/' | jq -r '.[]')"

  if [[ $? -ne 0 ]]; then
    log-error "Failed to parse '${file}'" || exit 1
  fi
else
  log-error "No new entries found in ${file}" || exit 0
fi

for extension in ${extensions}; do
  extensionName=$(echo "${extension}" | cut -d '.' -f 2)

  log-info "installing ${extensionName}"
  repeat-it "code --install-extension ${extension} --force &>/dev/null"
done

log-success "Installation Done ðŸš€"
