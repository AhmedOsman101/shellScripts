#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#  ▄▄           ██                                                       ▄▄                            ▄▄
#  ██           ▀▀                                                       ██                            ██
#  ██▄███▄    ████      ▄████▄   ████▄██▄   ▄████▄              ▄█████▄  ██▄████▄   ▄████▄    ▄█████▄  ██ ▄██▀
#  ██▀  ▀██     ██     ██▀  ▀██  ██ ██ ██  ██▄▄▄▄██            ██▀    ▀  ██▀   ██  ██▄▄▄▄██  ██▀    ▀  ██▄██
#  ██    ██     ██     ██    ██  ██ ██ ██  ██▀▀▀▀▀▀   █████    ██        ██    ██  ██▀▀▀▀▀▀  ██        ██▀██▄
#  ███▄▄██▀  ▄▄▄██▄▄▄  ▀██▄▄██▀  ██ ██ ██  ▀██▄▄▄▄█            ▀██▄▄▄▄█  ██    ██  ▀██▄▄▄▄█  ▀██▄▄▄▄█  ██  ▀█▄
#  ▀▀ ▀▀▀    ▀▀▀▀▀▀▀▀    ▀▀▀▀    ▀▀ ▀▀ ▀▀    ▀▀▀▀▀               ▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀▀     ▀▀▀▀▀   ▀▀   ▀▀▀
#
#
# --- DESCRIPTION --- #
# Runs the check command and fixes changes with biome.js
# --- DEPENDENCIES --- #
# - biome
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

# --- cmdarg setup --- #
cmdarg_info "header" "$(get-desc "$0")"

cmdarg "s" "summary" "Change the reporter type to summary"
cmdarg "u" "unsafe" "Apply unsafe fixes"
cmdarg "m?" "max-diagnostics" "Limit the amount of diagnostics displayed. When 'none' is provided, the limit is lifted." "20"

cmdarg_parse "$@"
# ---  Main script logic --- #

summary="${cmdarg_cfg["summary"]}"
unsafe="${cmdarg_cfg["unsafe"]}"
maxDiagnostics="${cmdarg_cfg["max-diagnostics"]}"

configFile="${BIOME_CONFIG_PATH:-${HOME}/.config/biome/biome.json}"

declare result

# Take the one at top-level
if is-git-repo --safe; then
  cd "$(git-root)"
  result="$(fd-by-depth --type f biome.json . | head -n 1)"
  # NOTE: Go to previous directory
  cd - &>/dev/null
fi

if [[ -z "${result}" ]]; then
  result="$(fd-by-depth --type f biome.json . | head -n 1)"
fi

cmdArray=(
  biome
  check
  --fix
  --max-diagnostics "${maxDiagnostics}"
)

if [[ -n ${result} && -f ${result} ]]; then
  cmdArray+=("--config-path=${result}")
elif [[ -n ${configFile} && -f ${configFile} ]]; then
  cmdArray+=("--config-path=${configFile}")
fi

[[ "${summary}" == true ]] && cmdArray+=(--reporter=summary)
[[ "${unsafe}" == true ]] && cmdArray+=(--unsafe)

cmdArray+=("${argv[@]}")

"${cmdArray[@]}"

exit 0
