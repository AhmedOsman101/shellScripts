#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                                                              ▄▄
#                        ██                                    ██
#   ▄███▄██   ▄████▄   ███████              ▄█████▄  ▄▄█████▄  ██ ▄██▀   ██▄███▄    ▄█████▄  ▄▄█████▄  ▄▄█████▄
#  ██▀  ▀██  ██▄▄▄▄██    ██                 ▀ ▄▄▄██  ██▄▄▄▄ ▀  ██▄██     ██▀  ▀██   ▀ ▄▄▄██  ██▄▄▄▄ ▀  ██▄▄▄▄ ▀
#  ██    ██  ██▀▀▀▀▀▀    ██       █████    ▄██▀▀▀██   ▀▀▀▀██▄  ██▀██▄    ██    ██  ▄██▀▀▀██   ▀▀▀▀██▄   ▀▀▀▀██▄
#  ▀██▄▄███  ▀██▄▄▄▄█    ██▄▄▄             ██▄▄▄███  █▄▄▄▄▄██  ██  ▀█▄   ███▄▄██▀  ██▄▄▄███  █▄▄▄▄▄██  █▄▄▄▄▄██
#   ▄▀▀▀ ██    ▀▀▀▀▀      ▀▀▀▀              ▀▀▀▀ ▀▀   ▀▀▀▀▀▀   ▀▀   ▀▀▀  ██ ▀▀▀     ▀▀▀▀ ▀▀   ▀▀▀▀▀▀    ▀▀▀▀▀▀
#   ▀████▀▀                                                              ██
#
# --- DESCRIPTION --- #
# Returns a suitable askpass program for sudo -A
# --- DEPENDENCIES --- #
#
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/helpers.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

# --- cmdarg setup --- #
cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
cmd=""

# Check if running in a graphical environment
if [[ -n "${DISPLAY}" || -n "${WAYLAND_DISPLAY}" ]]; then
  # Check for kdialog
  if command -v kdialog >/dev/null 2>&1; then
    cmd="kdialog --password 'Authentication Required'"
  # Check for zenity
  elif command -v zenity >/dev/null 2>&1; then
    cmd="zenity --password --title='Authentication Required' --timeout=30"
  # Check for yad (zenity fork)
  elif command -v yad >/dev/null 2>&1; then
    cmd="yad --entry --hide-text --title='Authentication Required' --button=OK:0 --timeout=30 --width=300 --height=150 --center"
  # Check for whiptail (alternative text-based UI for terminals)
  elif command -v whiptail >/dev/null 2>&1; then
    cmd="/bin/sh -c 'whiptail --passwordbox \"Authentication Required\" 8 40 2>&1 >/dev/tty; echo \$?'"
  # Check for dialog (text-based UI for terminals)
  elif command -v dialog >/dev/null 2>&1; then
    cmd="/bin/sh -c 'dialog --passwordbox \"Authentication Required\" 8 40 2>&1 >/dev/tty; echo \$?'"
  # Check for ssh-askpass (common in some X11 setups)
  elif command -v ssh-askpass >/dev/null 2>&1; then
    cmd="$(command -v ssh-askpass)"
  # Check for x11-ssh-askpass (alternative askpass tool)
  elif command -v x11-ssh-askpass >/dev/null 2>&1; then
    cmd="$(command -v x11-ssh-askpass)"
  else
    # Fallback for terminal prompt
    cmd="/bin/sh -c 'stty -echo; printf \"Password: \"; read password; stty echo; echo \"\$password\"'"
  fi
else
  # Non-graphical environment (terminal)
  # Check for whiptail
  if command -v whiptail >/dev/null 2>&1; then
    cmd="/bin/sh -c 'whiptail --passwordbox \"Authentication Required\" 8 40 2>&1 >/dev/tty; echo \$?'"
  # Check for dialog
  elif command -v dialog >/dev/null 2>&1; then
    cmd="/bin/sh -c 'dialog --passwordbox \"Authentication Required\" 8 40 2>&1 >/dev/tty; echo \$?'"
  else
    # Fallback for terminal prompt
    cmd="/bin/sh -c 'stty -echo; printf \"Password: \"; read password; stty echo; echo \"\$password\"'"
  fi
fi

path="$(dirname "$0")/askpass"

command -v askpass &>/dev/null && path="$(command -v askpass)"

cat >"${path}" <<EOF
#!/usr/bin/env bash

set -euo pipefail

# ---  Main script logic --- #
${cmd}
EOF

printf '%s' "${path}"
