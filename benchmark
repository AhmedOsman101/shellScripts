#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#  ▄▄                                      ▄▄                                      ▄▄
#  ██                                      ██                                      ██
#  ██▄███▄    ▄████▄   ██▄████▄   ▄█████▄  ██▄████▄  ████▄██▄   ▄█████▄   ██▄████  ██ ▄██▀
#  ██▀  ▀██  ██▄▄▄▄██  ██▀   ██  ██▀    ▀  ██▀   ██  ██ ██ ██   ▀ ▄▄▄██   ██▀      ██▄██
#  ██    ██  ██▀▀▀▀▀▀  ██    ██  ██        ██    ██  ██ ██ ██  ▄██▀▀▀██   ██       ██▀██▄
#  ███▄▄██▀  ▀██▄▄▄▄█  ██    ██  ▀██▄▄▄▄█  ██    ██  ██ ██ ██  ██▄▄▄███   ██       ██  ▀█▄
#  ▀▀ ▀▀▀      ▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀▀   ▀▀    ▀▀  ▀▀ ▀▀ ▀▀   ▀▀▀▀ ▀▀   ▀▀       ▀▀   ▀▀▀
#
#
# --- DESCRIPTION --- #
# Benchmarks a command by running it multiple times and collecting statistics
# --- DEPENDENCIES --- #
# - bc
# - awk
# --- END SIGNATURE --- #

trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/helpers.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

has-bash-version 5 3

# --- cmdarg setup --- #
cmdarg_info "header" "$(get-desc "$0")"
cmdarg "n:" "iterations" "Number of iterations to run"
cmdarg_parse "$@"
# --- Main script logic --- #
iterations="${cmdarg_cfg['iterations']}"
cmd=("${argv[@]}")

isPositiveInt "${iterations}" || log-error "Number of iterations must be a valid integer."
((0 < iterations)) || log-error "Number of iterations must be at least 1."

(( ${#cmd[@]} )) || log-error "No command specified."

start="${ date +%s.%N; }"

tmp="$(mktemp)"
trap 'rm -f "$tmp"' EXIT

for ((i=0; i < iterations; i++)); do
  # command time -f '%e' -o "${tmp}" -a -- "${cmd[@]}" &>/dev/null
  t1=${EPOCHREALTIME}
  "${cmd[@]}" &>/dev/null
  t2=${EPOCHREALTIME}
  awk "BEGIN {print ${t2} - ${t1}}" >>"${tmp}"
done

end="${ date +%s.%N; }"
elapsed=${ awk "BEGIN {print ${end} - ${start}}"; }

awk '
  {
    sum+=$1
    if(NR == 1 || $1 < min) min=$1
    if(NR == 1 || $1 > max) max=$1
  }
  END {
    avg = sum / NR

    unit = "s"
    scale = 1

    if (avg < 1e-3) { unit = "µs"; scale = 1e6 }
    else if (avg < 1) { unit = "ms"; scale = 1e3 }

    printf "runs: %d\n", NR
    printf "avg: %.3f%s\n", avg * scale, unit
    printf "min: %.3f%s\n", min * scale, unit
    printf "max: %.3f%s\n", max * scale, unit
  }
' "${tmp}"

printf "total: %s\n" "${ sec2time "${elapsed}" --short; }"
