#!/usr/bin/env bash
# shellcheck disable=SC2034 # Using Bash namerefs
# --- SCRIPT SIGNATURE --- #
#
#
#
#   ▄█████▄  ██▄███▄   ██▄███▄    ▄█████▄
#  ██▀    ▀  ██▀  ▀██  ██▀  ▀██  ██▀    ▀
#  ██        ██    ██  ██    ██  ██
#  ▀██▄▄▄▄█  ███▄▄██▀  ███▄▄██▀  ▀██▄▄▄▄█
#    ▀▀▀▀▀   ██ ▀▀▀    ██ ▀▀▀      ▀▀▀▀▀
#            ██        ██
#
# --- DESCRIPTION --- #
# Compiles and optionally runs C++ files with customizable compiler arguments
# --- DEPENDENCIES --- #
# - g++ (gcc)
# - xxh3sum (xxhash) | xxhsum (xxhash)
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/compile.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

# --- cmdarg setup --- #
cmdarg_info "header" "$(get-desc "$0")"

declare -a compiler_args
cmdarg "c" "compile" "Compile the files in the current working directory"
cmdarg "o?" "output" "Specify the output file name" ""
cmdarg "a?[]" "compiler_args" "Custom compiler arguments"
cmdarg "q" "quiet" "Supress all output"

cmdarg_parse "$@"
# ---  Main script logic --- #
compile="${cmdarg_cfg['compile']}"
output="${cmdarg_cfg['output']}"
quiet="${cmdarg_cfg['quiet']}"

((argc < 1)) && log-error "No input files were provided."

declare -a files

for file in "${argv[@]}"; do
  [[ ! -s "${file}" ]] && log-error "'${file}' does not exist or empty."
  [[ ! -r "${file}" ]] && log-error "File '${file}' is not readable."

  files+=("${file}")
done

# default flags as array (safe)
declare -a default_flags=("-std=c++23" "-Wall" "-Wextra" "-fdiagnostics-color=always")

# call compile_and_run passing array names (Bash namerefs used inside)
# signature: compile_and_run <compiler> <default_flags_array_name> <files_array_name> <compile_flag> <quiet_flag> <output> <compiler_args_array_name>
compile_and_run \
  'g++' \
  'default_flags' \
  'files' \
  "${compile}" \
  "${quiet}" \
  "${output}" \
  'compiler_args'
