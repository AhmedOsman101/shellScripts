#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                  ▄▄     ▄▄▄▄
#                  ██    ██▀▀▀               ██
#  ████▄██▄   ▄███▄██  ███████   ████▄██▄  ███████
#  ██ ██ ██  ██▀  ▀██    ██      ██ ██ ██    ██
#  ██ ██ ██  ██    ██    ██      ██ ██ ██    ██
#  ██ ██ ██  ▀██▄▄███    ██      ██ ██ ██    ██▄▄▄
#  ▀▀ ▀▀ ▀▀    ▀▀▀ ▀▀    ▀▀      ▀▀ ▀▀ ▀▀     ▀▀▀▀
#
#
# --- DESCRIPTION --- #
# Formats Markdown files using Prettier; auto-discovers files with fd or formats given .md/.markdown files
# --- DEPENDENCIES --- #
# - fd | fdfind (fd-find)
# - awk
# - prettier
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
declare -a files

if [[ "${argv[0]}" == "." ]] || ((argc == 0)); then
  # Populate the array directly from fd output
  mapfile -t files < <(fd . -e md -e markdown --hidden)
else
  for file in "${argv[@]}"; do
    [[ "${file##*.}" =~ ^(md|markdown)$ ]] && files+=("${file}")
  done
fi

# NOTE: ((0)) fails, while any other number succeeds
((${#files[@]})) || log-error "No valid markdown files were passed"

spinner.sh &
SPINNER_PID=$!

mdclean -q "${files[@]}" || log-warning "Failed to clean ${#file[@]} files"
mdmath -q "${files[@]}" || log-warning "Failed to fix math in ${#file[@]} files"
command -v emoji-strip &>/dev/null && emoji-strip "${files[@]}" &>/dev/null

killwait "${SPINNER_PID}"

prettier --write --config "${PRETTIERRC}" "${files[@]}"
