#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                  ▄▄     ▄▄▄▄
#                  ██    ██▀▀▀               ██
#  ████▄██▄   ▄███▄██  ███████   ████▄██▄  ███████
#  ██ ██ ██  ██▀  ▀██    ██      ██ ██ ██    ██
#  ██ ██ ██  ██    ██    ██      ██ ██ ██    ██
#  ██ ██ ██  ▀██▄▄███    ██      ██ ██ ██    ██▄▄▄
#  ▀▀ ▀▀ ▀▀    ▀▀▀ ▀▀    ▀▀      ▀▀ ▀▀ ▀▀     ▀▀▀▀
#
#
# --- DESCRIPTION --- #
# Formats Markdown files using Prettier; auto-discovers files with fd or formats given .md/.markdown files
# --- DEPENDENCIES --- #
# - fd | fdfind (fd-find)
# - awk
# - prettier
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
declare -a files

target="${argv[0]:-.}"

if [[ -d "${target}" ]] || ((argc == 0)); then
  # Populate the array directly from fd output
  mapfile -t files < <(fd-all . --exclude '.git' -e md -e markdown "${target}")
else
  for file in "${argv[@]}"; do
    [[ "${file##*.}" =~ ^(md|markdown)$ ]] && files+=("${file}")
  done
fi

# NOTE: ((0)) fails, while any other number succeeds
filesCount=${#files[@]}
((filesCount > 0)) || log-error "No valid markdown files were passed"

spinner.sh "Formatting ${filesCount} files..." &
SPINNER_PID=$!

mdmath -q "${files[@]}" || log-warning "Failed to fix math in ${filesCount} files"
mdclean -q "${files[@]}" || log-warning "Failed to clean ${filesCount} files"

killwait "${SPINNER_PID}"

prettier --write --config "${PRETTIERRC}" "${files[@]}"
