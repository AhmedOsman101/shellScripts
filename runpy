#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#
#
#   ██▄████  ██    ██  ██▄████▄  ██▄███▄   ▀██  ███
#   ██▀      ██    ██  ██▀   ██  ██▀  ▀██   ██▄ ██
#   ██       ██    ██  ██    ██  ██    ██    ████▀
#   ██       ██▄▄▄███  ██    ██  ███▄▄██▀     ███
#   ▀▀        ▀▀▀▀ ▀▀  ▀▀    ▀▀  ██ ▀▀▀       ██
#                                ██         ███
#
# --- DESCRIPTION --- #
# Run a Python script from $SCRIPTS_DIR/python with optional venv
# --- DEPENDENCIES --- #
# - python3
# - fd | fdfind (fd-find)
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
dir="${SCRIPTS_DIR}/python"

pattern="/$(strip-ext "$1" sh zsh fish bash).py\$"
file=$(fd "${pattern}" -p "${dir}")

venv=$(fd 'venv$' -t d -p "$(dirname "${file}")" --no-ignore)
activateVenv="${venv}bin/activate" # fd output adds a trailing /

# remove the script name from arguments and pass them to the target script
shift

withVenv() {
  source "${activateVenv}" || log-error "Couldn't execute the activate file: ${activateVenv}"
  python3 "${file}" "$@"
  deactivate && exit $?
}

if [[ -f "${activateVenv}" ]]; then
  withVenv "$@"
else
  python3 "${file}" "$@" && exit $?
fi
