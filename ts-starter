#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#
#    ██                                      ██                            ██
#  ███████   ▄▄█████▄            ▄▄█████▄  ███████    ▄█████▄   ██▄████  ███████    ▄████▄    ██▄████
#    ██      ██▄▄▄▄ ▀            ██▄▄▄▄ ▀    ██       ▀ ▄▄▄██   ██▀        ██      ██▄▄▄▄██   ██▀
#    ██       ▀▀▀▀██▄   █████     ▀▀▀▀██▄    ██      ▄██▀▀▀██   ██         ██      ██▀▀▀▀▀▀   ██
#    ██▄▄▄   █▄▄▄▄▄██            █▄▄▄▄▄██    ██▄▄▄   ██▄▄▄███   ██         ██▄▄▄   ▀██▄▄▄▄█   ██
#     ▀▀▀▀    ▀▀▀▀▀▀              ▀▀▀▀▀▀      ▀▀▀▀    ▀▀▀▀ ▀▀   ▀▀          ▀▀▀▀     ▀▀▀▀▀    ▀▀
#
#
# --- DESCRIPTION --- #
# Starter kit for typescript projects with formatter, editorconfig, and pre-commit hooks.
# Bootstrap typescript projects quickly, installs biome, husky, and editorconfig
# --- DEPENDENCIES --- #
# - npm | pnpm | bun | deno | yarn
# - gum
# - wget | curl
# - jq
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/helpers.sh")"
eval "$(include "lib/diff-handler.sh")"
eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg_info "header" "$(get-desc "$0")"
cmdarg "b?" "biome-version" "Biome version to install (default: 2.3.0)" "2.3.0"
cmdarg_parse "$@"

biomeVersion="${cmdarg_cfg['biome-version']}"

# ---  Main script logic --- #

fetch() {
  local url="$1" dest="$2"
  log-info "Fetching ${dest}..."

  if command -v wget >/dev/null 2>&1; then
    if ! wget -q -O "${dest}" "${url}" 2>/dev/null; then
      log-error "Failed to download ${url}"
    fi
  elif command -v curl >/dev/null 2>&1; then
    if ! curl -fsSL -o "${dest}" "${url}" 2>/dev/null; then
      log-error "Failed to download ${url}"
    fi
  else
    log-error "Neither wget nor curl is installed"
  fi
}

fetchRaw() {
  local repo="$1" file="$2" dest="$3" branch="${4:-main}"
  local url="https://raw.githubusercontent.com/${repo}/${branch}/${file}"

  fetch "${url}" "${dest}"
}

fetchGist() {
  local url="$1" file="$2" dest="$3"
  local gist_url="${url}/${file}"

  fetch "${gist_url}" "${dest}"
}

safeFetchRaw() {
  local repo="$1" file="$2" dest="$3" branch="${4:-main}"
  local tempFile="${dest}.tmp"
  local url="https://raw.githubusercontent.com/${repo}/${branch}/${file}"

  if [[ -f ${dest} ]]; then
    fetch "${url}" "${tempFile}"
    handleExistingFile "${dest}" "${tempFile}"
  else
    fetchRaw "$@"
  fi
}

safeFetchGist() {
  local url="$1" file="$2" dest="$3"
  local tempFile="${dest}.tmp"
  local gistUrl="${url}/${file}"

  if [[ -f ${dest} ]]; then
    fetch "${gistUrl}" "${tempFile}"
    handleExistingFile "${dest}" "${tempFile}"
  else
    fetchGist "$@"
  fi
}

# --- Command handlers --- #
addScripts() {
  jq '.scripts += {
  "lint": "biome lint .",
  "format": "biome check --fix .",
  "format:unsafe": "biome check --fix --unsafe .",
  "typecheck": "tsc --noUnusedLocals false --noUnusedParameters false --noEmit",
  "prepare": "husky"
}' package.json >tmp.json && mv tmp.json package.json
}

addTasks() {
  local file=${1:-deno.json}
  jq '.tasks += {
  "lint": "deno run -A npm:@biomejs/biome lint .",
  "format": "deno run -A npm:@biomejs/biome check --fix .",
  "format:unsafe": "deno run -A npm:@biomejs/biome check --fix --unsafe .",
  "prepare": "husky || true"
}' "${file}" >tmp.json && mv tmp.json "${file}"
}

# --- Package manager handlers --- #
handleNpm() {
  if is-git-repo --safe >/dev/null 2>&1; then
    npm install --save-dev husky && npx husky init
    rm '.husky/pre-commit' &>/dev/null || true
  fi
  npm install -D -E "@biomejs/biome@${biomeVersion}"
  addScripts
}

handlePnpm() {
  if is-git-repo --safe >/dev/null 2>&1; then
    pnpm add --save-dev husky && pnpm exec husky init
    rm '.husky/pre-commit' &>/dev/null || true
  fi

  pnpm add -D -E "@biomejs/biome@${biomeVersion}"
  addScripts
  pnpm approve-builds
}

handleYarn() {
  if is-git-repo --safe >/dev/null 2>&1; then
    yarn add --dev husky && {
      npx husky init || log-error "See the docs for husky at https://typicode.github.io/husky/get-started.html"
    }
    rm '.husky/pre-commit' &>/dev/null || true
  fi

  yarn add -D -E "@biomejs/biome@${biomeVersion}"
  addScripts
}

handleBun() {
  if is-git-repo --safe >/dev/null 2>&1; then
    bun add --dev husky && bunx husky init
    rm '.husky/pre-commit' &>/dev/null || true
  fi

  bun add -D -E "@biomejs/biome@${biomeVersion}"
  addScripts
}

handleDeno() {
  if is-git-repo --safe >/dev/null 2>&1; then
    deno add --dev npm:husky || true
    if [[ ! -f "package.json" ]]; then
      pnpm init
      pnpm dlx husky init || true
      rm "package.json"
    else
      pnpm dlx husky init || true
    fi
    rm '.husky/pre-commit' &>/dev/null || true
  fi

  deno add -D "npm:@biomejs/biome@${biomeVersion}"
  if [[ -f "deno.json" ]]; then
    addTasks "deno.json"
  elif [[ -f "deno.jsonc" ]]; then
    addTasks "deno.jsonc"
  else
    addScripts
  fi
}

if [[ -n $1 ]]; then
  cmd="$1"
else
  cmd=$(gum input --placeholder="Enter your starter command...")
  cmd=$(eval echo "${cmd}")
fi

[[ -z ${cmd} ]] && log-error "Empty commands aren't allowed"

pkgMgr=$(echo "${cmd}" | awk '{print $1}')

if ! command -v "${pkgMgr}" >/dev/null 2>&1; then
  log-error "The package manager '${pkgMgr}' is not installed"
fi

eval "${cmd}" || terminate

case "${pkgMgr}" in
npm) handleNpm ;;
pnpm) handlePnpm ;;
yarn) handleYarn ;;
bun) handleBun ;;
deno) handleDeno ;;
*) log-warning "Unknown package manager: ${pkgMgr}" && return 1 ;;
esac

if is-git-repo --safe >/dev/null 2>&1; then
  safeFetchRaw "AhmedOsman101/shellScripts" "templates/pre-commit-${pkgMgr}.sh" ".husky/pre-commit"
fi

mkdir -p .vscode

safeFetchRaw "AhmedOsman101/dotfiles" "Configs/biome/.config/biome/biome.json" "biome.json"
safeFetchRaw "AhmedOsman101/dotfiles" "Configs/editorconfig/.config/.editorconfig" ".editorconfig"

safeFetchGist "https://gist.githubusercontent.com/AhmedOsman101/5254232eb2c72a626cf798002d16a255/raw/ace64049d276de197887b65bbd9484f2fed710a1" "settings.json" ".vscode/settings.json"
safeFetchGist "https://gist.githubusercontent.com/AhmedOsman101/5254232eb2c72a626cf798002d16a255/raw/ace64049d276de197887b65bbd9484f2fed710a1" "extensions.json" ".vscode/extensions.json"
