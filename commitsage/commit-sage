#!/usr/bin/env bash

# shellcheck disable=SC2310
# disable hinting that invoking functions inside an if statement disables -e flag

set -eo pipefail

trap 'exit 1' SIGUSR1

is-git-repo

if [[ -z ${COMMIT_SAGE_CONFIG_PATH} ]]; then
  configFile="$(dirname $0)/config.yml"
  # log-debug "no config found"
  # log-debug "using default config: '${configFile}'"
else
  configFile="${COMMIT_SAGE_CONFIG_PATH}"
fi

onlyStaged=$(yq -r ".onlyStaged" ${configFile})

cd "$(git-root)" || log-error "unable to change directory to the git repo root directory"

hasChanges() {
  local type
  type=${1:-unstaged}

  case "${type}" in
  staged)
    output=$(git diff --cached --name-only)
    ;;
  untracked)
    output=$(git ls-files --others --exclude-standard)
    ;;
  deleted)
    output=$(git ls-files --deleted)
    ;;
  unstaged)
    output=$(git diff --name-only)
    ;;
  ? | *)
    log-error "Invalid change type: ${type}"
    ;;
  esac
  # output.length > 0
  output=$(trim "${output}")

  # True (0) if output is non-empty
  [[ ${#output} -gt 0 ]] && return 0 || return 1
}

hasHead() {
  git rev-parse HEAD >/dev/null 2>&1 && return 0 || return 1
}

# Simple hash function mimicking TypeScript's calculateFileHash
calculateFileHash() {
  local content="$1"
  # Convert content to base64 and take first 7 characters
  echo -n "${content}" | base64 | head -c 7
}

isSubModule() {
  if git ls-files --stage -- $1 | rg -q "160000"; then
    return 0
  else
    return 1
  fi
}

processStagedOnly() {
  local output stagedFiles=()
  # Get staged files
  output=$(git diff --cached --name-only)

  # Check if git command succeeded
  [[ $? -ne 0 ]] && log-error "Error: Git command failed"

  mapfile -t lines <<<"${output}"
  for line in "${lines[@]}"; do
    trimmed=$(trim "${line}")
    if [[ -n "${trimmed}" ]]; then
      stagedFiles+=("${trimmed}")
    fi
  done

  for file in "${stagedFiles[@]}"; do
    if ! isSubModule "file"; then
      local fileDiff=$(git diff --cached -- ${file})
      trimmed=$(trim "${fileDiff}")
      if [[ -n "${trimmed}" ]]; then
        diffs+=("${trimmed}")
      fi
    fi
  done
}

processStaged() {
  local output stagedFiles=()
  # Get staged files
  output=$(git diff --cached --name-only)

  # Check if git command succeeded
  [[ $? -ne 0 ]] && log-error "Error: Git command failed"

  mapfile -t lines <<<"${output}"
  for line in "${lines[@]}"; do
    trimmed=$(trim "${line}")
    if [[ -n "${trimmed}" ]]; then
      stagedFiles+=("${trimmed}")
    fi
  done

  # Generate diff for each staged file
  for file in "${stagedFiles[@]}"; do
    if ! isSubModule "file"; then
      local fileDiff=$(git diff --cached -- ${file})
      trimmed=$(trim "${fileDiff}")
      if [[ -n "${trimmed}" ]]; then
        diffs+=($'# Staged changes:\n'"${trimmed}")
      fi
    fi
  done
}

