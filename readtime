#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                                      ▄▄               ██
#                                      ██    ██         ▀▀
#   ██▄████   ▄████▄    ▄█████▄   ▄███▄██  ███████    ████     ████▄██▄   ▄████▄
#   ██▀      ██▄▄▄▄██   ▀ ▄▄▄██  ██▀  ▀██    ██         ██     ██ ██ ██  ██▄▄▄▄██
#   ██       ██▀▀▀▀▀▀  ▄██▀▀▀██  ██    ██    ██         ██     ██ ██ ██  ██▀▀▀▀▀▀
#   ██       ▀██▄▄▄▄█  ██▄▄▄███  ▀██▄▄███    ██▄▄▄   ▄▄▄██▄▄▄  ██ ██ ██  ▀██▄▄▄▄█
#   ▀▀         ▀▀▀▀▀    ▀▀▀▀ ▀▀    ▀▀▀ ▀▀     ▀▀▀▀   ▀▀▀▀▀▀▀▀  ▀▀ ▀▀ ▀▀    ▀▀▀▀▀
#
#
# --- DESCRIPTION --- #
# Accepts file(s) or raw text and outputs how long it takes to read in minutes.
# --- DEPENDENCIES --- #
# - pandoc
# - wc
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/helpers.sh")"
eval "$(include "check-deps")"
checkDeps "$0"

# --- cmdarg setup --- #
cmdarg_info "header" "$(get-desc "$0")"
cmdarg 'q' 'quiet' "Quiet output, prints only minutes to read"
cmdarg 'w?' 'wpm' "Words per minute" '200'
cmdarg_parse "$@"
# ---  Main script logic --- #
quiet="${cmdarg_cfg[quiet]}"
WPM="${cmdarg_cfg[wpm]}"

total=0
processed_count=0


# Determine input mode and validate
if ! [[ -t 0 ]]; then
  # stdin mode: ignore file arguments

  stdin_words="$(input "$@" | pandoc -t plain 2>/dev/null | wc -w | trim)"
  minutes=$(((stdin_words + WPM - 1) / WPM))
  ((minutes < 1)) && minutes=1
  ((total += minutes))
  ((++processed_count))

  if [[ "${quiet}" != true ]]; then
    printf '%s min read\n' "${minutes}"
  else
    printf '%sm\n' "${minutes}"
  fi
else
  # file mode: validate all files first
  if ((argc == 0)); then
    log-error "No files provided and stdin is not available"
  fi

  # Validate all files before processing
  for file in "${argv[@]}"; do
    if [[ ! -r "${file}" ]]; then
      log-error "Cannot read file ${file} it's either protected or doesn't exist"
    fi
  done

  # Process valid files
  for file in "${argv[@]}"; do
    # Suppress pandoc warnings for unknown file formats (process substitution)
    words="$(pandoc "${file}" -t plain 2>/dev/null | wc -w | trim)"

    minutes=$(((words + WPM - 1) / WPM))
    ((minutes < 1)) && minutes=1
    ((total += minutes))
    ((++processed_count))

    if [[ "${quiet}" != true ]]; then
      printf '%s min read %s\n' "${minutes}" "${file}"
    else
      printf '%sm\n' "${minutes}"
    fi
  done
fi

# Show TOTAL only if we processed multiple inputs
if ((processed_count > 1)); then
  if [[ "${quiet}" != true ]]; then
    printf '%s min read TOTAL\n' "${total}"
  else
    printf '%sm TOTAL\n' "${total}"
  fi
fi
