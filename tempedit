#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                                                          ▄▄     ██
#    ██                                                    ██     ▀▀       ██
#  ███████    ▄████▄   ████▄██▄  ██▄███▄    ▄████▄    ▄███▄██   ████     ███████
#    ██      ██▄▄▄▄██  ██ ██ ██  ██▀  ▀██  ██▄▄▄▄██  ██▀  ▀██     ██       ██
#    ██      ██▀▀▀▀▀▀  ██ ██ ██  ██    ██  ██▀▀▀▀▀▀  ██    ██     ██       ██
#    ██▄▄▄   ▀██▄▄▄▄█  ██ ██ ██  ███▄▄██▀  ▀██▄▄▄▄█  ▀██▄▄███  ▄▄▄██▄▄▄    ██▄▄▄
#     ▀▀▀▀     ▀▀▀▀▀   ▀▀ ▀▀ ▀▀  ██ ▀▀▀      ▀▀▀▀▀     ▀▀▀ ▀▀  ▀▀▀▀▀▀▀▀     ▀▀▀▀
#                                ██
#
# --- DESCRIPTION --- #
# Creates a temporary file to edit with the given extension
# --- DEPENDENCIES --- #
# - nano
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg "p" "preserve" "Keep the file after the editing is done, the default is deleting it."
cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
preserve="${cmdarg_cfg['preserve']}"
extension="${argv[0]:-md}"

EDITOR="${EDITOR:-nano}"

# Validate the extension is safe (no path components)
if [[ "${extension}" == */* ]]; then
  log-error "Extension cannot contain path separators"
fi

file="$(mktemp -t "tempedit-XXXXX.${extension}")"
if [[ ${preserve} == true ]]; then
  clipcopy "${file}"
  log-info "File name copied to clipboard!"
else
  trap 'rm -f "$file"' EXIT
fi

# Validate EDITOR exists
if ! command -v "${EDITOR}" &>/dev/null; then
  log-error "Editor '${EDITOR}' not found"
else
  "${EDITOR}" "${file}"
fi
