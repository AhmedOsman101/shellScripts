#!/usr/bin/env bash

set -eo pipefail

trap 'exit 1' SIGUSR1

source cmdarg.sh

# ----  Main script logic ---- #
cmdarg_info "header" "A script for creating bash scripts automatically"

cmdarg "t" "temp" "Creates the script at /tmp and copies its name to clipboard"
cmdarg "f" "file" "Creates the script in the current working directory"

cmdarg_parse "$@"

isTemp=${cmdarg_cfg['temp']}
isFile=${cmdarg_cfg['file']}
# Store option values
no_flags=false
file=""

[[ $# -eq 0 ]] && no_flags=true

if [[ "${isTemp}" == true ]]; then
  file=$(mktemp -t XXXXX-script.sh)
  name="${file}"
  clipcopy "${file}"
  log-info "The script name was copied to clipboard"

elif [[ "${isFile}" == true ]]; then
  name=$(gum input --placeholder "Enter Script's name: ")
  file="${PWD}/${name}"
  mkdir -p "$(dirname ${file})" 2>/dev/null
  name="$(basename ${file})"

  if [[ "${name}" != *.sh ]]; then
    gum confirm "Do you want to add .sh extension to your script?" && file="${PWD}/${name}.sh"
  fi

elif [[ "${no_flags}" == true ]]; then
  name=$(gum input --placeholder "Enter Script's name: ")
  file="${SCRIPTS_DIR}/${name}"
  name="$(basename ${file})"
fi

[[ -f "${file}" && "${isTemp}" == false ]] && log-error "The script '${name}' already exists at '${file}'!"

touch "${file}" || log-error "Failed to create file '${file}'"

text=$(
  cat <<EOF
#!/usr/bin/env bash

set -euo pipefail

EOF
)

echo "${text}" >"${file}"

chmod u+x "${file}" || log-error "Failed to make '$(basename ${file})' executable"

"${EDITOR}" "${file}"

log-success "Script '$(basename ${file})' created succefully!"
