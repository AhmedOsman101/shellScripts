#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                                ▄▄
#    ██                          ██
#  ███████   ██    ██   ▄█████▄  ██ ▄██▀    ██▄████            ▄▄█████▄  ▀██  ███  ██▄████▄   ▄█████▄
#    ██      ██    ██  ██▀    ▀  ██▄██      ██▀                ██▄▄▄▄ ▀   ██▄ ██   ██▀   ██  ██▀    ▀
#    ██      ██    ██  ██        ██▀██▄     ██        █████     ▀▀▀▀██▄    ████▀   ██    ██  ██
#    ██▄▄▄   ██▄▄▄███  ▀██▄▄▄▄█  ██  ▀█▄    ██                 █▄▄▄▄▄██     ███    ██    ██  ▀██▄▄▄▄█
#     ▀▀▀▀    ▀▀▀▀ ▀▀    ▀▀▀▀▀   ▀▀   ▀▀▀   ▀▀                  ▀▀▀▀▀▀      ██     ▀▀    ▀▀    ▀▀▀▀▀
#                                                                         ███
#
# --- DESCRIPTION --- #
# Sync all top-level Tuckr packages
# --- DEPENDENCIES --- #
# - tuckr
# - fd | fdfind (fd-find)
# - cut
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
path="${TUCKR_DIR:-${HOME}/.config/dotfiles/Configs}"

cd "${path}" || log-error "Invalid tuckr directory: ${path}"

declare -a packages
mapfile -t packages < <(fd . --type d -d 1 | cut -d '/' -f1)

count=0
for package in "${packages[@]}"; do
  log-info "Adding package: ${package}"
  tuckr add "${package}" || log-warning "Failed to sync package ${package}"

  # ((0)) returns 1 which is a failure
  # that would trigger the `set -e` option to exit the script
  ((++count))
done

log-success "Synced ${count} tuckr packages"
