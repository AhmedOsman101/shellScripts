#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                  ▄▄                                ▄▄
#                  ██                        ██      ██
#  ████▄██▄   ▄███▄██  ████▄██▄   ▄█████▄  ███████   ██▄████▄
#  ██ ██ ██  ██▀  ▀██  ██ ██ ██   ▀ ▄▄▄██    ██      ██▀   ██
#  ██ ██ ██  ██    ██  ██ ██ ██  ▄██▀▀▀██    ██      ██    ██
#  ██ ██ ██  ▀██▄▄███  ██ ██ ██  ██▄▄▄███    ██▄▄▄   ██    ██
#  ▀▀ ▀▀ ▀▀    ▀▀▀ ▀▀  ▀▀ ▀▀ ▀▀   ▀▀▀▀ ▀▀     ▀▀▀▀   ▀▀    ▀▀
#
#
# --- DESCRIPTION --- #
# Replaces LaTeX math delimiters with Obsidian's delimiters in a given file
# Usage: mdmath <file>
# --- DEPENDENCIES --- #
#
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/helpers.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg_info "header" "$(get-desc "$0")"
cmdarg "q" "quiet" "Supress output"
cmdarg_parse "$@"
# ---  Main script logic --- #
# Check if the correct number of arguments is passed
if ((argc < 1)); then
  cmdarg_usage
  exit 1
fi

isQuiet="${cmdarg_cfg['quiet']}"

for file in "${argv[@]}"; do
  # Check if the file exists
  if [[ ! -f ${file} ]]; then
    log-warning "File '${file}' was not found!"
    continue
  fi

  # Count occurrences of all delimiters to be replaced
  count_display=$(grep -o '\\\[' "${file}" | wc -l || true)
  count_inline=$(grep -o '\\(' "${file}" | wc -l || true)

  count=$((count_display + count_inline))

  if ! ((count)); then
    [[ "${isQuiet}" == true ]] || log-info "Nothing to do!"
    continue
  fi

  # Perform the replacements
  sed -i -e 's~\\\[~$$~g' \
    -e 's~\\\]~$$~g' \
    -e 's~ \\)~$~g' \
    -e 's~\\( ~$~g' \
    -e 's~\\(~$~g' \
    -e 's~\\)~$~g' "${file}"

  [[ "${isQuiet}" == true ]] || log-success "${count} Replacements made"
done
