#!/usr/bin/env bash
#
# --- SCRIPT SIGNATURE --- #
#
#                  ▄▄                                ▄▄
#                  ██                        ██      ██
#  ████▄██▄   ▄███▄██  ████▄██▄   ▄█████▄  ███████   ██▄████▄
#  ██ ██ ██  ██▀  ▀██  ██ ██ ██   ▀ ▄▄▄██    ██      ██▀   ██
#  ██ ██ ██  ██    ██  ██ ██ ██  ▄██▀▀▀██    ██      ██    ██
#  ██ ██ ██  ▀██▄▄███  ██ ██ ██  ██▄▄▄███    ██▄▄▄   ██    ██
#  ▀▀ ▀▀ ▀▀    ▀▀▀ ▀▀  ▀▀ ▀▀ ▀▀   ▀▀▀▀ ▀▀     ▀▀▀▀   ▀▀    ▀▀
#
#
# --- DESCRIPTION --- #
# Replaces LaTeX math delimiters with Obsidian's delimiters in a given file
# Usage: mdmath <file>
# --- DEPENDENCIES --- #
#
# --- END SIGNATURE --- #

set -eo pipefail
trap 'exit 1' SIGUSR1

eval "$(include "lib/cmdarg.sh")"
eval "$(include "lib/helpers.sh")"
eval "$(include "check-deps")"

checkDeps "$0"
cmdarg_info "header" "$(get-desc "$0")"
cmdarg_parse "$@"
# ---  Main script logic --- #
file="${argv[0]}"

# Check if the correct number of arguments is passed
if ((1 < argc)) || [[ -z "${file}" ]]; then
  cmdarg_usage
  exit 1
fi

# Check if the file exists
[[ -f ${file} ]] || log-error "File '${file}' does not exist."

# Count occurrences of all delimiters to be replaced
count_display=$(grep -o '\\\[' "${file}" | wc -l || true)
count_inline=$(grep -o '\\(' "${file}" | wc -l || true)

count=$((count_display + count_inline))

((count)) || terminate "Nothing to do"

# Perform the replacements
sed -i -e 's~\\\[~$$~g' \
  -e 's~\\\]~$$~g' \
  -e 's~ \\)~$~g' \
  -e 's~\\( ~$~g' \
  -e 's~\\(~$~g' \
  -e 's~\\)~$~g' "${file}"

log-success "${count} Replacements made"
